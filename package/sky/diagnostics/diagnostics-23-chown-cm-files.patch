diff -Naurr diagnostics-1.3_orig/apps/cmfilechk/main.c diagnostics-1.3_new/apps/cmfilechk/main.c
--- diagnostics-1.3_orig/apps/cmfilechk/main.c	1970-01-01 01:00:00.000000000 +0100
+++ diagnostics-1.3_new/apps/cmfilechk/main.c	2015-06-19 15:31:43.148827631 +0100
@@ -0,0 +1,132 @@
+/*
+Based on Code from Rosetta
+http://rosettacode.org/wiki/Walk_a_directory/Recursively#C
+GNU Free Documentation License 1.2.
+Copyright (c).
+Permission is granted to copy, distribute and/or modify this document
+under the terms of the GNU Free Documentation License, Version 1.2
+or any later version published by the Free Software Foundation;
+with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
+Texts.  A copy of the license is included in the section entitled "GNU
+Free Documentation License".
+*/
+/*
+ * Now that TR069 has to be run as a non-root user, there will be some
+ * STBs where the files in /opt/cm/ are owned by root:root.
+ * This program will change them to tr069:tr069, before starting the TR069 Daemons.
+ */
+
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
+#include <dirent.h>
+#include <regex.h>
+#include <stdio.h>
+#include <string.h>
+#include <errno.h>
+#include <err.h>
+ 
+enum {
+	WALK_OK = 0,
+	WALK_BADPATTERN,
+	WALK_NAMETOOLONG,
+	WALK_BADIO,
+};
+ 
+#define WS_NONE		0
+#define WS_RECURSIVE	(1 << 0)
+#define WS_DEFAULT	WS_RECURSIVE
+#define WS_FOLLOWLINK	(1 << 1)	/* follow symlinks */
+#define WS_DOTFILES	(1 << 2)	/* per unix convention, .file is hidden */
+#define WS_MATCHDIRS	(1 << 3)	/* if pattern is used on dir names too */
+
+#define SKY_TR069_UID (21000)
+#define SKY_TR069_GID (21000)
+ 
+int walk_recur(char *dname, regex_t *reg, int spec)
+{
+	struct dirent *dent;
+	DIR *dir;
+	struct stat st;
+	char fn[FILENAME_MAX];
+	int res = WALK_OK;
+	int len = strlen(dname);
+	if (len >= FILENAME_MAX - 1){
+		return WALK_NAMETOOLONG;
+	}
+ 
+	strncpy(fn, dname, len);
+	fn[len++] = '/';
+ 
+	if (!(dir = opendir(dname))) {
+		warn("can't open %s", dname);
+		return WALK_BADIO;
+	}
+ 
+	errno = 0;
+	while ((dent = readdir(dir))) {
+		if (!(spec & WS_DOTFILES) && dent->d_name[0] == '.'){
+			continue;
+		}
+		if (!strcmp(dent->d_name, ".") || !strcmp(dent->d_name, "..")){
+			continue;
+		}
+ 
+		strncpy(fn + len, dent->d_name, FILENAME_MAX - len);
+		if (lstat(fn, &st) == -1) {
+			warn("Can't stat %s", fn);
+			res = WALK_BADIO;
+			continue;
+		}
+ 
+		/* don't follow symlink unless told so */
+		if (S_ISLNK(st.st_mode) && !(spec & WS_FOLLOWLINK)){
+			continue;
+		}
+ 
+		/* will be false for symlinked dirs */
+		if (S_ISDIR(st.st_mode)) {
+			/* recursively follow dirs */
+			if ((spec & WS_RECURSIVE)){
+				walk_recur(fn, reg, spec);
+			}
+ 
+			if (!(spec & WS_MATCHDIRS)){
+				 continue;
+			}
+		}
+ 
+		/* pattern match */
+		if (!regexec(reg, fn, 0, 0, 0)){
+			 puts(fn);
+			/* Change Owner and group to tr069 */
+			 chown(fn, SKY_TR069_UID, SKY_TR069_GID);
+		}
+	}
+ 
+	if (dir){
+		 closedir(dir);
+	}
+	return res ? res : errno ? WALK_BADIO : WALK_OK;
+}
+ 
+int walk_dir(char *dname, char *pattern, int spec)
+{
+	regex_t r;
+	int res;
+	if (regcomp(&r, pattern, REG_EXTENDED | REG_NOSUB)){
+		return WALK_BADPATTERN;
+	}
+	res = walk_recur(dname, &r, spec);
+	regfree(&r);
+ 
+	return res;
+}
+ 
+int main()
+{
+int r;
+	r = walk_dir("/opt/cm/", "cmlegacy.??", WS_DEFAULT);
+	r = walk_dir("/opt/cm/", "sky_tr69_*", WS_DEFAULT);
+	return 0;
+}
diff -Naurr diagnostics-1.3_orig/apps/cmfilechk/Makefile.am diagnostics-1.3_new/apps/cmfilechk/Makefile.am
--- diagnostics-1.3_orig/apps/cmfilechk/Makefile.am	1970-01-01 01:00:00.000000000 +0100
+++ diagnostics-1.3_new/apps/cmfilechk/Makefile.am	2015-06-19 16:04:22.195612437 +0100
@@ -0,0 +1,6 @@
+include $(top_srcdir)/proj_defs.mk
+
+bin_PROGRAMS = cmfilechk
+
+cmfilechk_SOURCES = main.c 
+
diff -Naurr diagnostics-1.3_orig/apps/Makefile.am diagnostics-1.3_new/apps/Makefile.am
--- diagnostics-1.3_orig/apps/Makefile.am	2014-12-04 12:41:40.000000000 +0000
+++ diagnostics-1.3_new/apps/Makefile.am	2015-06-19 16:05:13.372920802 +0100
@@ -11,5 +11,6 @@
 	mifd \
 	testd \
 	iptest \
+	cmfilechk \
 	uploadd \
 	xmppd
diff -Naurr diagnostics-1.3_orig/configure.ac diagnostics-1.3_new/configure.ac
--- diagnostics-1.3_orig/configure.ac	2014-12-04 12:41:40.000000000 +0000
+++ diagnostics-1.3_new/configure.ac	2015-06-19 17:08:17.154416112 +0100
@@ -92,6 +92,8 @@
 
 AC_CONFIG_FILES([apps/iptest/Makefile])
 
+AC_CONFIG_FILES([apps/cmfilechk/Makefile])
+
 AC_CONFIG_FILES([apps/uploadd/Makefile])
 
 AC_CONFIG_FILES([apps/xmppd/Makefile])
